<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.mapper.ProductMapper">

    <!-- 상품 등록한 사용자 이름 조회 -->
    <select id="selectProductMember" parameterType="int" resultType="String">
        select  member_name
        from product p join member m
                         on p.member_no = m.member_no
        where p.prd_no = #{prdNo}
    </select>

  
	<!-- 상품 목록 -->
	<select id="selectProductList">
	    select *
	    from (
			select p.*
			from   product p
			order by p.prd_no desc
	    )
	    <![CDATA[ 
	    where rownum  <= 16
	    ]]>
    </select>
  
    <!-- 상품 단건 조회 -->
    <select id="selectProduct" parameterType="int" resultType="product">
        select *
        from   product
        where  prd_no = #{prdNo}
    </select>
	
	<!-- 상품 조회수 증가 -->
	<update id="updateCntProduct" parameterType="int">
		update product
		set view_cnt = view_cnt + 1
		where prd_no = #{prdNo}
	</update>
	
	<!-- 상품 수정 -->
	<update id="updateProduct" parameterType="product">
		update product
		set prd_name = #{prdName},
		    price = #{price},
		    category = #{category},
		    prd_status = #{prdStatus},
		    prd_desc = #{prdDesc},
		    prd_tag = #{prdTag},
		    trade_type = #{tradeType},
		    prd_img = #{prdImg},
		    sido = #{sido},
		    sigungu = #{sigungu},
		    dong = #{dong},
		    lat = #{lat},
		    lng = #{lng}
		where prd_no = #{prdNo} 
	</update>	
	
	<!-- 상품 등록 -->
	<insert id="insertProduct">
		insert into product (prd_no, 
		                     prd_name, 
		                     price, 
		                     category, 
		                     prd_status, 
		                     prd_desc, 
		                     prd_tag, 
		                     trade_type, 
		                     sale_status, 
		                     prd_img, 
		                     member_no, 
		                     sido, 
		                     sigungu, 
		                     dong, 
		                     lat, 
		                     lng)		
		values (product_seq.nextval,
		       #{prdName},
		       #{price},
		       #{category},
		       #{prdStatus},
			   #{prdDesc},
			   #{prdTag},
			   #{tradeType},
			   #{saleStatus},
			   #{prdImg},
			   #{memberNo},
			   #{sido},
			   #{sigungu},
			   #{dong},
			   #{lat},
			   #{lng})
	</insert>		

	
	<!-- 상품 삭제 -->
	<delete id="deleteProduct" parameterType="int">
		delete from product
		where prd_no = #{prdNo}
	</delete>	
	
	<!-- 상품 판매상태 수정 -->
	<update id="updateSaleStatus">
		update product
		set sale_status = #{saleStatus}
		where prd_no = #{prdNo}
	</update>		
	
	
	<!--  내가 한 찜 목록보기  -->
	<select id="selectWish" parameterType="int" resultType="product">
	    select  p.prd_no,
	            p.prd_name,
	            p.price,
	            p.prd_img,
	            p.sale_status,
	            w.wish_no
	    from wish w join product p
	                  on w.prd_no = p.prd_no
	    where w.member_no = #{memberNo}
	    order by w.wish_no desc
	</select>

    <!--  내가 판매하는 물건 조회  -->
    <select id="selectSale" parameterType="int" resultType="product">
        select  *
        from    product
        where   member_no = #{memberNo}
        order by prd_date desc
    </select>

    <!--  내가 구매한 물건 조회  -->
    <select id="selectPur" parameterType="int" resultType="product">
        select  prd.prd_no,
                prd.prd_name,
                prd.price,
                prd.prd_img,
                prd.sale_status,
                pur.pur_no,
                r.review_no
        from    purchase pur join product prd
                               on pur.prd_no = prd.prd_no
                        left join review r
                               on r.pur_no = pur.pur_no
        where pur.member_no = #{memberNo}
        order by pur.pur_no desc
    </select>
	
  	<!-- 목록 조회: 페이지당 10개 고정 -->
  <select id="selectProducts" parameterType="com.yedam.common.SearchDTO" resultType="product">
    SELECT *
    FROM (
      SELECT ROWNUM rn, p.*
      FROM (
        SELECT
          prd_no, prd_name, prd_tag, price, prd_img,
          prd_date AS prdDate,
          category, sido, sigungu, dong, trade_type, sale_status, view_cnt
        FROM product
        <where>
          <!-- 카테고리 -->
         <if test="category != null and category != '' and category != 'ALL' and category != '전체'">
            AND category = #{category}
          </if>

          <!-- 키워드 + 검색조건 -->
          <if test="keyword != null and keyword != ''">
            <choose>
              <!-- 상품명 검색 -->
              <when test="searchCondition == 'N'">
                AND prd_name LIKE '%' || #{keyword} || '%'
              </when>
              <!-- 태그 검색 -->
              <when test="searchCondition == 'T'">
                AND prd_tag  LIKE '%' || #{keyword} || '%'
              </when>
              <!-- 지역(통합) 검색: 시/도, 시군구, 동 통합 LIKE -->
              <when test="searchCondition == 'F'">
                AND (
                     sido    LIKE '%' || #{keyword} || '%'
                  OR sigungu LIKE '%' || #{keyword} || '%'
                  OR dong    LIKE '%' || #{keyword} || '%'
                )
              </when>
              <!-- 미지정/ALL: 이름+태그(+지역) 전체에서 검색 -->
              <otherwise>
                AND (
                       prd_name LIKE '%' || #{keyword} || '%'
                    OR prd_tag  LIKE '%' || #{keyword} || '%'
                    OR sido     LIKE '%' || #{keyword} || '%'
                    OR sigungu  LIKE '%' || #{keyword} || '%'
                    OR dong     LIKE '%' || #{keyword} || '%'
                )
              </otherwise>
            </choose>
          </if>
        </where>
        
         <choose>
        <when test="sort == 'price_asc'">
          <!-- 가격 오름차순, 동가일 때 최신 우선 -->
          ORDER BY price NULLS LAST, prd_no DESC
        </when>
        <when test="sort == 'price_desc'">
          <!-- 가격 내림차순, 동가일 때 최신 우선 -->
          ORDER BY price DESC NULLS LAST, prd_no DESC
        </when>
        <otherwise>
          <!-- 최신순(기본) -->
          ORDER BY prd_no DESC
          <!-- 또는 등록일 기준이면: ORDER BY prd_date DESC, prd_no DESC -->
        </otherwise>
      </choose>
      ) p
    )
    WHERE rn BETWEEN (#{page}-1)*12 + 1 AND #{page}*12
    <!-- ↑ 페이지당 10개 고정. 20개로 바꾸려면 10을 20으로만 바꾸면 됩니다. -->
  </select>



  <!-- 총 건수 (페이징 계산용) : 목록 WHERE와 동일 조건 유지 -->
  <select id="countProducts" parameterType="com.yedam.common.SearchDTO" resultType="int">
    SELECT COUNT(*)
    FROM product
    <where>
      <if test="category != null and category != '' and category != 'ALL' and category != '전체'">
        AND category = #{category}
      </if>

      <if test="keyword != null and keyword != ''">
        <choose>
          <when test="searchCondition == 'N'">
            AND prd_name LIKE '%' || #{keyword} || '%'
          </when>
          <when test="searchCondition == 'T'">
            AND prd_tag  LIKE '%' || #{keyword} || '%'
          </when>
          <when test="searchCondition == 'F'">
            AND (
                 sido    LIKE '%' || #{keyword} || '%'
              OR sigungu LIKE '%' || #{keyword} || '%'
              OR dong    LIKE '%' || #{keyword} || '%'
            )
          </when>
          <otherwise>
            AND (
                   prd_name LIKE '%' || #{keyword} || '%'
                OR prd_tag  LIKE '%' || #{keyword} || '%'
                OR sido     LIKE '%' || #{keyword} || '%'
                OR sigungu  LIKE '%' || #{keyword} || '%'
                OR dong     LIKE '%' || #{keyword} || '%'
            )
          </otherwise>
        </choose>
      </if>
    </where>
  </select>





</mapper>
