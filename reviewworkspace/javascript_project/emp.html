<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="./images/favicon.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <script type="text/javascript">
      const server = "http://localhost:9090";

      document.addEventListener("DOMContentLoaded", function (event) {
        // DOM이 완성된 후 코드를 실행
        getEmpList();
        getJobList();

        // 이벤트처리
        document
          .querySelector("#btnInsert")
          .addEventListener("click", insertEmpInfo);
      });

      // 사원 전체조회
      async function getEmpList() {
        let empList = await fetch(`http://localhost:9090/emp`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        // <tbody /> 하위태그 전체 삭제 -> innerHTML로 강제초기화 or 자식요소를 전부끌어내서 일일이 제거 (여기선 후자)
        let trTags = document.querySelector(
          ".overflow-auto table.table > tbody"
        ).children;
        Array.from(trTags).forEach((trTag) => trTag.remove());
        // trTags가 배열이니 forEach, 근데 이게 배열로 인식이 안되어서 강제로 인식하게끔 Array처리
        // 그리고 그 안에 있는 것들을 하나씩 삭제

        for (let empInfo of empList) {
          // empInfo : 사원
          // -> employeeId, lastName, firstName, jobId
          createTrTag(
            empInfo.employeeId,
            empInfo.lastName,
            empInfo.firstName,
            empInfo.jobId
          );
        }
      }
      function createTrTag(employeeId, lastName, firstName, jobId) {
        let trTag = `<tr>
                  <td class="text-center">${employeeId}</td>
                  <td class="text-center">${lastName + firstName}</td>
                  <td class="text-center">${jobId}</td>
                  <td class="text-center">
                    <button class="btnUpd">조회</button>
                    <button class="btnDel">삭제</button>
                  </td>
                </tr>`;

        let tbody = document.querySelector(
          ".overflow-auto table.table > tbody"
        );

        tbody.insertAdjacentHTML("beforeend", trTag);

        // tbody
        //   .querySelector("tr > button.btnUpd")
        //   .addEventListener("click", getEmpInfo);
        Array.from(tbody.querySelectorAll("tr button.btnUpd"))
          .pop()
          .addEventListener("click", getEmpInfo);
      }

      // 직업 전체조회
      async function getJobList() {
        // 1. 데이터가져오기 : http://localhost:9090/job
        // AJAX -> jobList
        let jobList = await fetch(`${server}/job`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        // 2. jobList를 기반으로 태그 생성
        // 2-1. jobList => 배열 - for, for each, for of 다 사용 가능
        for (let jobInfo of jobList) {
          // 2-2. jobInfo {"jobId" : "ddd", "jobTitle" : "aaa", ...}
          createOptionTag(jobInfo.jobId, jobInfo.jobTitle);
        }
      }
      function createOptionTag(jobId, jobTitle) {
        // 1. <option value="">선택</option> 생성
        let optionTag = document.createElement("option");
        optionTag.value = jobId;
        optionTag.textContent = jobTitle;

        // 2. <select/> 탐색
        document
          .querySelector('#form1 [name="jobId"]')
          .insertAdjacentElement("beforeend", optionTag);
      }

      // 사원등록
      async function insertEmpInfo() {
        // 1. 사용자가 입력한 데이터
        let empInfo = getFormInfo();

        // 2. 서버에 전송
        let result = await fetch(`${server}/emp`, {
          // 추가 옵션
          method: "post",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(empInfo),
        })
          .then((res) => res.json())
          .catch((err) => console.log(err));

        // 3. 결과 처리
        console.log(result);
        if (result) {
          // 등록 성공
          getEmpList();
          form1.reset();
        } else {
          alert("등록실패");
        }
      }
      // <form /> 태그 안에 입력태그의 값을 가져오기
      function getFormInfo() {
        const formTag = new FormData(form1);
        let obj = {};
        for (let key of formTag.keys()) {
          let name = key;
          let value = formTag.get(key);
          console.log(name, value);
          obj[name] = value;
        }
        console.log(obj);
        return obj;
      }

      // 사원단건조회
      async function getEmpInfo(event) {
        // 조회버튼
        let selectBtn = event.currentTarget;
        let trTag = selectBtn.closest("tr");
        let firstTdTag = trTag.firstElementChild;
        let empId = firstTdTag.textContent;

        let empInfo = await fetch(`${server}/emp/${empId}`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        form1.querySelector('[name="employeeId"]').value = empInfo.employeeId;
        form1.querySelector('[name="firstName"]').value = empInfo.firstName;
        form1.querySelector('[name="lastName"]').value = empInfo.lastName;
        form1.querySelector('[name="email"]').value = empInfo.email;
        form1.querySelector('[name="hireDate"]').value = empInfo.hireDate;
        form1.querySelector('[name="jobId"]').value = empInfo.jobId;
      }
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col">
          <h2>사원 목록</h2>
          <div class="overflow-auto border" style="height: 700px">
            <table class="table text-center">
              <thead>
                <tr>
                  <th class="text-center">사번</th>
                  <th class="text-center">이름</th>
                  <th class="text-center">JOB</th>
                  <th class="text-center"></th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="text-center">100</td>
                  <td class="text-center">홍길동</td>
                  <td class="text-center">PROGRAMER</td>
                  <td class="text-center">
                    <button class="btnUpd">조회</button>
                    <button class="btnDel">삭제</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="col">
          <!-- form태그에 name을 넣으면, 그대로 윈도우에 변수가 되어 console에서 찍어보면 바로 나온다. form태그 사용시 name 속성 사용하는것 권장함 -->
          <form id="form1" name="form1" class="form-horizontal">
            <h2>사원 등록 및 수정</h2>
            <div class="border">
              <div class="form-group m-3">
                <label>사번:</label>
                <input
                  type="text"
                  class="form-control"
                  readonly
                  name="employeeId"
                />
              </div>
              <div class="form-group m-3">
                <label>이름:</label>
                <input
                  type="text"
                  class="form-control"
                  name="firstName"
                  placeholder="firstName"
                />
                <input
                  type="text"
                  class="form-control"
                  name="lastName"
                  placeholder="lastName"
                />
              </div>
              <div class="form-group m-3">
                <label>이메일:</label>
                <input type="text" class="form-control" name="email" />
              </div>
              <div class="form-group m-3">
                <label>입사일자:</label>
                <input type="date" class="form-control" name="hireDate" />
              </div>
              <div class="form-group m-3">
                <label>역할:</label>
                <select class="form-control" name="jobId" id="jobId">
                  <option value="">선택</option>
                </select>
              </div>
              <div class="form-group m-2">
                <input
                  type="button"
                  class="btn btn-primary"
                  value="등록"
                  id="btnInsert"
                />
                <input
                  type="button"
                  class="btn btn-primary"
                  value="수정"
                  id="btnUpdate"
                />
                <input
                  type="button"
                  class="btn btn-primary"
                  value="초기화"
                  id="btnInit"
                />
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
