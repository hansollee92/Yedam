<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="./images/favicon.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <script type="text/javascript">
      const server = "http://www.yd3team.store/api";

      document.addEventListener("DOMContentLoaded", function (event) {
        getEquiList();
        getEquitsList();

        document
          .querySelector("#btnInsert")
          .addEventListener("click", insertEquipInfo);
      });

      // 설비 전체조회
      async function getEquiList() {
        let equiList = await fetch(`${server}/equipment`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        // 하위 전체 삭제
        let trTags = document.querySelector(
          ".overflow-auto table.table > tbody"
        ).children;
        Array.from(trTags).forEach((trTag) => trTag.remove());

        for (let equipInfo of equiList) {
          createTrTag(
            equipInfo.equip_code,
            equipInfo.equip_name,
            equipInfo.equip_type,
            equipInfo.manager
          );
        }
      }
      function createTrTag(equip_code, equip_name, equip_type, manager) {
        let trTag = `<tr>
                  <td class="text-center">${equip_code}</td>
                  <td class="text-center">${equip_name}</td>
                  <td class="text-center">${equip_type}</td>
                  <td class="text-center">${manager}</td>
                  <td class="text-center">
                    <button class="btnUpd">조회</button>
                    <button class="btnDel">삭제</button>
                  </td>
                </tr>`;
        let tbody = document.querySelector(
          ".overflow-auto table.table > tbody"
        );

        tbody.insertAdjacentHTML("beforeend", trTag);

        Array.from(tbody.querySelectorAll("tr button.btnUpd"))
          .pop()
          .addEventListener("click", getEquipInfo);
      }

      // 설비유형 전체조회
      async function getEquitsList() {
        let equipmentsList = await fetch(`${server}/equipments`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        for (let equipmentsInfo of equipmentsList) {
          createOptionTag(equipmentsInfo.code, equipmentsInfo.name);
        }
      }
      function createOptionTag(code, name) {
        let optionTag = `<option value="${code}">${name}</option>`;
        let tbody = document.querySelector("#equipments");
        tbody.insertAdjacentHTML("beforeend", optionTag);
      }

      // 단건조회
      async function getEquipInfo(event) {
        // 조회버튼
        let selectBtn = event.currentTarget;
        let trTag = selectBtn.closest("tr");
        let firstTdTag = trTag.firstElementChild;
        let equipId = firstTdTag.textContent;

        let equipInfo = await fetch(`${server}/equipment/${equipId}`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        form1.querySelector('[name="equip_code"]').value = equipInfo.equip_code;
        form1.querySelector('[name="equip_name"]').value = equipInfo.equip_name;
        form1.querySelector('[name="equip_type"]').value = equipInfo.equip_type;
        form1.querySelector('[name="manager"]').value = equipInfo.manager;

        // 날짜 변경 yyyy-MM-dd
        function dateForm(e) {
          let d = new Date(e);
          let year = d.getFullYear();
          let mon = ("0" + (d.getMonth() + 1)).slice(-2);
          let date = ("0" + d.getDate()).slice(-2);
          let idForm = year + "-" + mon + "-" + date;
          return idForm;
        }
        form1.querySelector('[name="install_date"]').value = dateForm(
          equipInfo.install_date
        );
        form1.querySelector('[name="mfg_dt"]').value = dateForm(
          equipInfo.mfg_dt
        );
      }

      // 설비 등록
      async function insertEquipInfo() {
        let equiptInfo = getFormInfo();

        let result = await fetch(`${server}/equipment`, {
          method: "post",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(equiptInfo),
        })
          .then((res) => res.json())
          .catch((err) => console.log(err));

        console.log(result);
        if (result) {
          getEquiList();
          form1.reset();
        } else {
          alert("등록실패");
        }
      }

      // form 태그 안 입력태그 값 가져오기
      function getFormInfo() {
        const formTag = new FormData(form1);
        let obj = {};
        for (let key of formTag.keys()) {
          let name = key;
          let value = formTag.get(key);
          console.log(name, value);
          obj[name] = value;
        }
        console.log(obj);
        return obj;
      }
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col">
          <h2>설비 목록</h2>
          <div class="overflow-auto border" style="height: 700px">
            <table class="table text-center">
              <thead>
                <tr>
                  <th class="text-center">설비코드</th>
                  <th class="text-center">설비명</th>
                  <th class="text-center">설비유형</th>
                  <th class="text-center">담당자</th>
                  <th class="text-center"></th>
                </tr>
              </thead>

              <tbody>
                <!-- <tr>
                  <td class="text-center">EQ-20251023-009</td>
                  <td class="text-center">세척기4호기</td>
                  <td class="text-center">설비유형</td>
                  <td class="text-center">박봉근</td>
                  <td class="text-center">
                    <button class="btnUpd">조회</button>
                    <button class="btnDel">삭제</button>
                  </td>
                </tr> -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="col">
          <form id="form1" class="form-horizontal">
            <h2>설비 등록 및 수정</h2>
            <div class="border">
              <div class="form-group m-3">
                <label>설비코드:</label>
                <input
                  type="text"
                  class="form-control"
                  readonly
                  name="equip_code"
                />
              </div>
              <div class="form-group m-3">
                <label>설비명:</label>
                <input
                  type="text"
                  class="form-control"
                  name="equip_name"
                  placeholder="equipment name"
                />
              </div>
              <div class="form-group m-3">
                <label>설비유형:</label>
                <select class="form-control" name="equip_type" id="equipments">
                  <option value="">선택</option>
                </select>
              </div>
              <div class="form-group m-3">
                <label>담당자:</label>
                <input type="text" class="form-control" name="manager" />
              </div>
              <div class="form-group m-3">
                <label>설치일자:</label>
                <input type="date" class="form-control" name="install_date" />
              </div>
              <div class="form-group m-3">
                <label>제조일자:</label>
                <input type="date" class="form-control" name="mfg_dt" />
              </div>
              <div class="form-group m-2">
                <input
                  type="button"
                  class="btn btn-primary"
                  value="등록"
                  id="btnInsert"
                />
                <input
                  type="button"
                  class="btn btn-primary"
                  value="수정"
                  id="btnUpdate"
                />
                <input
                  type="button"
                  class="btn btn-primary"
                  value="초기화"
                  id="btnInit"
                />
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
